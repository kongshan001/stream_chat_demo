# å®Œæ•´èŠå¤©åº”ç”¨è¯¦è§£

> åŸºäº `examples/06_complete_chat.py` çš„æ·±å…¥è§£æ

## ç›®å½•

- [åº”ç”¨æ¦‚è¿°](#åº”ç”¨æ¦‚è¿°)
- [æŠ€æœ¯æ¶æ„](#æŠ€æœ¯æ¶æ„)
- [FastAPIæ ¸å¿ƒæ¦‚å¿µ](#fastapiæ ¸å¿ƒæ¦‚å¿µ)
- [SSEå®æ—¶é€šä¿¡](#sseå®æ—¶é€šä¿¡)
- [ä»£ç é€è¡Œè§£æ](#ä»£ç é€è¡Œè§£æ)
- [å‰åç«¯äº¤äº’æµç¨‹](#å‰åç«¯äº¤äº’æµç¨‹)
- [chat.htmlå‰ç«¯å®ç°](#chathtmlå‰ç«¯å®ç°)
- [è¿è¡Œå’Œæµ‹è¯•](#è¿è¡Œå’Œæµ‹è¯•)
- [æ‰©å±•å’Œä¼˜åŒ–](#æ‰©å±•å’Œä¼˜åŒ–)

---

## åº”ç”¨æ¦‚è¿°

### åŠŸèƒ½ç‰¹æ€§

**è¿™æ˜¯ä¸€ä¸ªå®Œæ•´çš„AIèŠå¤©åº”ç”¨ï¼ŒåŒ…å«ï¼š**

| åŠŸèƒ½ | è¯´æ˜ |
|------|------|
| âœ… **æµå¼è¾“å‡º** | é€å­—ç¬¦å®æ—¶æ˜¾ç¤ºAIå“åº” |
| âœ… **æ€è€ƒè¿‡ç¨‹** | å¯è§†åŒ–AIçš„æ€è€ƒæ­¥éª¤ |
| âœ… **SSEåè®®** | ä½¿ç”¨Server-Sent Eventså®æ—¶é€šä¿¡ |
| âœ… **ç°ä»£UI** | ç¾è§‚çš„èŠå¤©ç•Œé¢ |
| âœ… **è·¨åŸŸæ”¯æŒ** | æ”¯æŒå‰åç«¯åˆ†ç¦»éƒ¨ç½² |
| âœ… **å¤šæ¥å£** | æ”¯æŒGETå’ŒPOSTè¯·æ±‚ |

### æŠ€æœ¯æ ˆ

**åç«¯ï¼š**
- FastAPI - ç°ä»£Webæ¡†æ¶
- uvicorn - ASGIæœåŠ¡å™¨
- å¼‚æ­¥ç”Ÿæˆå™¨ - æµå¼æ•°æ®ç”Ÿæˆ

**å‰ç«¯ï¼š**
- åŸç”ŸJavaScript - æ— éœ€æ¡†æ¶
- Fetch API - ç½‘ç»œè¯·æ±‚
- CSS3 - ç°ä»£UIæ ·å¼

### åº”ç”¨åœºæ™¯

- ğŸ“± AIå¯¹è¯åŠ©æ‰‹
- ğŸ’¬ å®¢æœç³»ç»Ÿ
- ğŸ¤– èŠå¤©æœºå™¨äºº
- ğŸ“š æ™ºèƒ½é—®ç­”
- ğŸ“ åœ¨çº¿è¾…å¯¼

---

## æŠ€æœ¯æ¶æ„

### 1. æ•´ä½“æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  æµè§ˆå™¨å®¢æˆ·ç«¯                    â”‚
â”‚                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚         chat.html                       â”‚   â”‚
â”‚  â”‚  - èŠå¤©ç•Œé¢                            â”‚   â”‚
â”‚  â”‚  - æ¶ˆæ¯å±•ç¤º                            â”‚   â”‚
â”‚  â”‚  - è¾“å…¥æ¡†                              â”‚   â”‚
â”‚  â”‚  - EventSource/Fetch API               â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚ HTTP POST /chat
                       â”‚ SSEæµ
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              FastAPI æœåŠ¡å™¨                      â”‚
â”‚                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  @app.post("/chat")                    â”‚   â”‚
â”‚  â”‚    â†“                                   â”‚   â”‚
â”‚  â”‚  StreamingResponse                     â”‚   â”‚
â”‚  â”‚    â†“                                   â”‚   â”‚
â”‚  â”‚  generate_chat_response(message)       â”‚   â”‚
â”‚  â”‚    â†“                                   â”‚   â”‚
â”‚  â”‚  å¼‚æ­¥ç”Ÿæˆå™¨ (async generator)          â”‚   â”‚
â”‚  â”‚    â†“                                   â”‚   â”‚
â”‚  â”‚  SSEæ ¼å¼è¾“å‡º                           â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                 â”‚
â”‚  - CORSä¸­é—´ä»¶                                  â”‚
â”‚  - è·¯ç”±ç®¡ç†                                    â”‚
â”‚  - æµå¼å“åº”                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2. æ•°æ®æµå›¾

```
ç”¨æˆ·è¾“å…¥æ¶ˆæ¯
    â†“
å‰ç«¯æ•è·è¾“å…¥
    â†“
å‘é€ POST /chat
    â”œâ”€ Headers: Content-Type: application/json
    â””â”€ Body: {"message": "ä½ å¥½"}
        â†“
FastAPI æ¥æ”¶è¯·æ±‚
    â†“
è°ƒç”¨ generate_chat_response()
    â†“
å¼‚æ­¥ç”Ÿæˆå™¨å¼€å§‹å·¥ä½œ
    â”‚
    â”œâ”€ yield "event: start\n\n"  â†’  è¿æ¥æˆåŠŸ
    â”‚
    â”œâ”€ yield "event: thinking\n\n"  â†’  æ­£åœ¨æ€è€ƒ
    â”‚
    â”œâ”€ yield "event: content\n\n"  â†’  é€å­—è¾“å‡º
    â”‚   (å¾ªç¯æ¯ä¸ªå­—ç¬¦)
    â”‚
    â””â”€ yield "event: done\n\n"  â†’  å®Œæˆ
        â†“
StreamingResponse åŒ…è£…
    â†“
HTTPå“åº”
    â”œâ”€ Content-Type: text/event-stream
    â””â”€ Transfer-Encoding: chunked
        â†“
æµè§ˆå™¨æ¥æ”¶SSEæµ
    â†“
å‰ç«¯è§£æå¹¶æ˜¾ç¤º
    â”‚
    â”œâ”€ startäº‹ä»¶ â†’ æ˜¾ç¤ºè¿æ¥æˆåŠŸ
    â”œâ”€ thinkingäº‹ä»¶ â†’ æ›´æ–°æ€è€ƒçŠ¶æ€
    â”œâ”€ contentäº‹ä»¶ â†’ è¿½åŠ å­—ç¬¦
    â””â”€ doneäº‹ä»¶ â†’ ç»“æŸ
```

---

## FastAPIæ ¸å¿ƒæ¦‚å¿µ

### 1. ä»€ä¹ˆæ˜¯FastAPIï¼Ÿ

**å®šä¹‰ï¼š** FastAPIæ˜¯ä¸€ä¸ªç°ä»£ã€å¿«é€Ÿï¼ˆé«˜æ€§èƒ½ï¼‰çš„Webæ¡†æ¶ï¼Œç”¨äºåŸºäºæ ‡å‡†Pythonç±»å‹æç¤ºæ„å»ºAPIã€‚

**æ ¸å¿ƒç‰¹ç‚¹ï¼š**
- âš¡ é«˜æ€§èƒ½ï¼ˆæ¥è¿‘NodeJSå’ŒGoï¼‰
- ğŸš€ å¿«é€Ÿç¼–ç ï¼ˆå¼€å‘é€Ÿåº¦æå‡200-300%ï¼‰
- ğŸ“š æ›´å°‘çš„bugï¼ˆå‡å°‘çº¦40%çš„å¼€å‘é”™è¯¯ï¼‰
- ğŸ“– ç›´è§‚çš„ä»£ç ï¼ˆæ”¯æŒè‡ªåŠ¨æ–‡æ¡£ï¼‰
- ğŸ¨ ç°ä»£åŒ–ï¼ˆè‡ªåŠ¨ç”ŸæˆOpenAPIæ–‡æ¡£ï¼‰

### 2. æ ¸å¿ƒç»„ä»¶

**åº”ç”¨å®ä¾‹ï¼š**
```python
from fastapi import FastAPI

app = FastAPI()
```

**è·¯ç”±è£…é¥°å™¨ï¼š**
```python
@app.get("/")
@app.post("/chat")
@app.get("/chat/{message}")
```

**å¼‚æ­¥è·¯ç”±ï¼š**
```python
@app.get("/")
async def home():
    return {"message": "Hello"}
```

### 3. è·¯ç”±å®šä¹‰å¯¹æ¯”

| æ–¹æ³• | è£…é¥°å™¨ | ç”¨é€” | ç¤ºä¾‹ |
|------|--------|------|------|
| GET | `@app.get()` | è·å–æ•°æ® | æŸ¥è¯¢ä¿¡æ¯ |
| POST | `@app.post()` | æäº¤æ•°æ® | å‘é€æ¶ˆæ¯ |
| PUT | `@app.put()` | æ›´æ–°æ•°æ® | æ›´æ–°èµ„æ–™ |
| DELETE | `@app.delete()` | åˆ é™¤æ•°æ® | åˆ é™¤æ¡ç›® |

### 4. StreamingResponse

**å®šä¹‰ï¼š** å“åº”æµå¼æ•°æ®çš„ç‰¹æ®Šç±»ã€‚

**å‚æ•°ï¼š**
```python
StreamingResponse(
    content,          # ç”Ÿæˆå™¨æˆ–å¼‚æ­¥ç”Ÿæˆå™¨
    media_type,       # åª’ä½“ç±»å‹
    headers,          # è‡ªå®šä¹‰å“åº”å¤´
    status_code,      # HTTPçŠ¶æ€ç 
)
```

**ä½¿ç”¨ç¤ºä¾‹ï¼š**
```python
from fastapi import FastAPI
from fastapi.responses import StreamingResponse

app = FastAPI()

async def generate():
    for i in range(10):
        yield f"æ•°æ® {i}\n"
        await asyncio.sleep(0.1)

@app.get("/")
async def stream():
    return StreamingResponse(
        generate(),
        media_type="text/plain",
        headers={"Cache-Control": "no-cache"},
    )
```

---

## SSEå®æ—¶é€šä¿¡

### 1. SSEåœ¨FastAPIä¸­çš„å®ç°

**åŸºæœ¬æ ¼å¼ï¼š**
```python
async def generate_sse():
    yield f"event: start\ndata: {json.dumps({'status':'connected'})}\n\n"
    yield f"event: content\ndata: {json.dumps({'text':'ä½ å¥½'})}\n\n"
    yield f"event: done\ndata: {json.dumps({'reason':'complete'})}\n\n"

@app.get("/stream")
async def stream():
    return StreamingResponse(
        generate_sse(),
        media_type="text/event-stream",
        headers={
            "Cache-Control": "no-cache",
            "Connection": "keep-alive",
        },
    )
```

**å…³é”®å“åº”å¤´ï¼š**

| å¤´å­—æ®µ | å€¼ | è¯´æ˜ |
|--------|-----|------|
| `Content-Type` | `text/event-stream` | æ ‡è¯†SSEæµ |
| `Cache-Control` | `no-cache` | ç¦æ­¢ç¼“å­˜ |
| `Connection` | `keep-alive` | ä¿æŒé•¿è¿æ¥ |

### 2. äº‹ä»¶ç±»å‹è®¾è®¡

**æœ¬åº”ç”¨çš„äº‹ä»¶ç±»å‹ï¼š**

```python
events = {
    "start": {"message": "è¿æ¥æˆåŠŸ"},
    "thinking": {"step": "æ­£åœ¨åˆ†æ..."},
    "content": {"text": "ä½ "},
    "done": {"reason": "å®Œæˆ"}
}
```

**å‰ç«¯ç›‘å¬ï¼š**
```javascript
evtSource.addEventListener('start', (e) => {
    console.log('å·²è¿æ¥');
});

evtSource.addEventListener('thinking', (e) => {
    const data = JSON.parse(e.data);
    showThinking(data.step);
});

evtSource.addEventListener('content', (e) => {
    const data = JSON.parse(e.data);
    appendText(data.text);
});

evtSource.addEventListener('done', (e) => {
    evtSource.close();
});
```

### 3. SSEæ•°æ®æ ¼å¼

**å•ä¸ªäº‹ä»¶ï¼š**
```
event: start
data: {"status":"connected"}

```

**æ³¨æ„ï¼š**
- äº‹ä»¶ä¹‹é—´å¿…é¡»æœ‰ç©ºè¡Œï¼ˆ`\n\n`ï¼‰
- dataå­—æ®µå¿…é¡»æ˜¯JSONå­—ç¬¦ä¸²
- eventå­—æ®µæ˜¯å¯é€‰çš„

---

## ä»£ç é€è¡Œè§£æ

### 1. å¯¼å…¥å’Œåˆå§‹åŒ– (1-17è¡Œ)

```python
from fastapi import FastAPI
from fastapi.responses import StreamingResponse
from fastapi.middleware.cors import CORSMiddleware
import asyncio
import json


app = FastAPI()

# å…è®¸è·¨åŸŸè®¿é—®
app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)
```

**é€è¡Œè§£é‡Šï¼š**

| è¡Œå· | ä»£ç  | è¯´æ˜ |
|------|------|------|
| 1-2 | FastAPIå¯¼å…¥ | æ ¸å¿ƒæ¡†æ¶ |
| 3 | StreamingResponse | æµå¼å“åº”ç±» |
| 4 | CORSMiddleware | è·¨åŸŸä¸­é—´ä»¶ |
| 5-6 | asyncio, json | å¼‚æ­¥å’ŒJSONå¤„ç† |
| 8 | `app = FastAPI()` | åˆ›å»ºåº”ç”¨å®ä¾‹ |
| 10-17 | CORSé…ç½® | å…è®¸è·¨åŸŸè®¿é—® |

**CORSä¸­é—´ä»¶è¯´æ˜ï¼š**
```python
allow_origins=["*"]           # å…è®¸æ‰€æœ‰æ¥æº
allow_credentials=True        # å…è®¸æºå¸¦å‡­è¯
allow_methods=["*"]           # å…è®¸æ‰€æœ‰HTTPæ–¹æ³•
allow_headers=["*"]           # å…è®¸æ‰€æœ‰è¯·æ±‚å¤´
```

**ä¸ºä»€ä¹ˆéœ€è¦CORSï¼Ÿ**
```
å‰ç«¯: http://localhost:3000
åç«¯: http://localhost:8000

æµè§ˆå™¨ä¼šé˜»æ­¢è·¨åŸŸè¯·æ±‚ï¼ˆå®‰å…¨æœºåˆ¶ï¼‰
CORSå…è®¸ç‰¹å®šåŸŸåçš„è·¨åŸŸè¯·æ±‚
```

### 2. ç”ŸæˆèŠå¤©å“åº” (20-46è¡Œ)

```python
async def generate_chat_response(message: str):
    """ç”ŸæˆèŠå¤©å“åº” - SSEæ ¼å¼"""

    # å‘é€å¼€å§‹äº‹ä»¶
    yield f"event: start\ndata: {json.dumps({'message': 'è¿æ¥æˆåŠŸ'})}\n\n"

    # æ¨¡æ‹Ÿæ€è€ƒè¿‡ç¨‹
    thinking_steps = [
        "æ­£åœ¨ç†è§£ä½ çš„é—®é¢˜...",
        "åˆ†æä¸Šä¸‹æ–‡ä¿¡æ¯...",
        "æœç´¢ç›¸å…³çŸ¥è¯†...",
        "æ„å»ºå›ç­”å†…å®¹...",
    ]

    for step in thinking_steps:
        yield f"event: thinking\ndata: {json.dumps({'step': step})}\n\n"
        await asyncio.sleep(0.5)

    # æ¨¡æ‹ŸAIé€å­—è¾“å‡º
    response = f"ä½ è¯´çš„æ˜¯ï¼š{message}ã€‚è¿™æ˜¯ä¸€ä¸ªå®Œæ•´çš„AIèŠå¤©æ¼”ç¤ºï¼Œæ”¯æŒæµå¼è¾“å‡ºï¼"

    for char in response:
        yield f"event: content\ndata: {json.dumps({'text': char})}\n\n"
        await asyncio.sleep(0.03)

    # å‘é€å®Œæˆäº‹ä»¶
    yield f"event: done\ndata: {json.dumps({'reason': 'å®Œæˆ'})}\n\n"
```

**æ‰§è¡Œæµç¨‹ï¼š**

```
T0:   yield startäº‹ä»¶
T0:   "è¿æ¥æˆåŠŸ"

T0:   yield thinkingäº‹ä»¶
T0.5: "æ­£åœ¨ç†è§£ä½ çš„é—®é¢˜..."

T0.5: yield thinkingäº‹ä»¶
T1.0: "åˆ†æä¸Šä¸‹æ–‡ä¿¡æ¯..."

T1.0: yield thinkingäº‹ä»¶
T1.5: "æœç´¢ç›¸å…³çŸ¥è¯†..."

T1.5: yield thinkingäº‹ä»¶
T2.0: "æ„å»ºå›ç­”å†…å®¹..."

T2.0: yield contentäº‹ä»¶
T2.03: "ä½ "

T2.03: yield contentäº‹ä»¶
T2.06: "è¯´"

... (é€å­—è¾“å‡º)

T2.5: yield doneäº‹ä»¶
      "å®Œæˆ"
```

### 3. ç”Ÿæˆæ™®é€šæ–‡æœ¬æµ (49-65è¡Œ)

```python
async def generate_plain_stream():
    """ç”Ÿæˆæ™®é€šæ–‡æœ¬æµ"""

    messages = [
        "è¿™æ˜¯ä¸€ä¸ªå®Œæ•´çš„AIèŠå¤©æ¼”ç¤ºï¼\n",
        "æ”¯æŒä»¥ä¸‹åŠŸèƒ½ï¼š\n",
        "1. Server-Sent Events (SSE) åè®®\n",
        "2. æµå¼é€å­—è¾“å‡º\n",
        "3. æ€è€ƒè¿‡ç¨‹å¯è§†åŒ–\n",
        "4. å®Œæ•´çš„èŠå¤©ç•Œé¢\n\n",
        "ä½ å¯ä»¥å°è¯•å‘é€ä»»æ„æ¶ˆæ¯ï¼\n",
    ]

    for msg in messages:
        for char in msg:
            yield char
            await asyncio.sleep(0.02)
```

**ä½¿ç”¨åœºæ™¯ï¼š**
- é¦–é¡µæ¼”ç¤º
- ä¸éœ€è¦SSEçš„ç®€å•æµå¼è¾“å‡º
- æµ‹è¯•æµå¼æ•ˆæœ

### 4. è·¯ç”±å®šä¹‰

#### é¦–é¡µè·¯ç”± (68-75è¡Œ)

```python
@app.get("/")
async def home():
    """é¦–é¡µ - æ¼”ç¤ºæµå¼è¾“å‡º"""
    return StreamingResponse(
        generate_plain_stream(),
        media_type="text/plain",
        headers={"Cache-Control": "no-cache"},
    )
```

#### GETèŠå¤©è·¯ç”± (78-88è¡Œ)

```python
@app.get("/chat/{message}")
async def chat(message: str):
    """èŠå¤©æ¥å£ - SSEæ ¼å¼"""
    return StreamingResponse(
        generate_chat_response(message),
        media_type="text/event-stream",
        headers={
            "Cache-Control": "no-cache",
            "Connection": "keep-alive",
        },
    )
```

**è·¯å¾„å‚æ•°ï¼š**
```python
@app.get("/chat/{message}")
async def chat(message: str):
    # URL: /chat/ä½ å¥½
    # message = "ä½ å¥½"
```

#### POSTèŠå¤©è·¯ç”± (91-102è¡Œ)

```python
@app.post("/chat")
async def chat_post(message: dict):
    """POSTèŠå¤©æ¥å£"""
    user_message = message.get("message", "")
    return StreamingResponse(
        generate_chat_response(user_message),
        media_type="text/event-stream",
        headers={
            "Cache-Control": "no-cache",
            "Connection": "keep-alive",
        },
    )
```

**è¯·æ±‚ä½“ï¼š**
```json
{
  "message": "ä½ å¥½"
}
```

**ä¸ºä»€ä¹ˆåŒæ—¶æä¾›GETå’ŒPOSTï¼Ÿ**

| æ–¹æ³• | ä¼˜ç‚¹ | ç¼ºç‚¹ | é€‚ç”¨åœºæ™¯ |
|------|------|------|----------|
| GET | ç®€å•ï¼Œå¯ä»¥ç›´æ¥åœ¨æµè§ˆå™¨æµ‹è¯• | URLé•¿åº¦é™åˆ¶ï¼Œä¸é€‚åˆé•¿æ¶ˆæ¯ | ç®€å•æµ‹è¯• |
| POST | æ”¯æŒé•¿æ¶ˆæ¯ï¼Œæ›´å®‰å…¨ | éœ€è¦æ„é€ è¯·æ±‚ä½“ | ç”Ÿäº§ç¯å¢ƒ |

### 5. å¯åŠ¨æœåŠ¡å™¨ (105-119è¡Œ)

```python
if __name__ == "__main__":
    import uvicorn

    print("=" * 60)
    print("å®Œæ•´AIèŠå¤©åº”ç”¨")
    print("=" * 60)
    print("\nå¯åŠ¨æœåŠ¡...")
    print("APIç«¯ç‚¹:")
    print("  GET  http://localhost:8000/")
    print("  GET  http://localhost:8000/chat/{message}")
    print("  POST http://localhost:8000/chat")
    print("\næŒ‰ Ctrl+C åœæ­¢æœåŠ¡")
    print("=" * 60 + "\n")

    uvicorn.run(app, host="0.0.0.0", port=8000)
```

**uvicornå‚æ•°ï¼š**
```python
uvicorn.run(
    app,              # FastAPIåº”ç”¨
    host="0.0.0.0",   # ç›‘å¬æ‰€æœ‰ç½‘ç»œæ¥å£
    port=8000,        # ç«¯å£å·
    reload=True,      # å¼€å‘æ¨¡å¼ï¼ˆå¯é€‰ï¼‰
    workers=4,        # å·¥ä½œè¿›ç¨‹æ•°ï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰
)
```

---

## å‰åç«¯äº¤äº’æµç¨‹

### 1. å®Œæ•´äº¤äº’æ—¶åºå›¾

```
ç”¨æˆ·              æµè§ˆå™¨å‰ç«¯              FastAPIåç«¯
 â”‚                   â”‚                        â”‚
 â”‚â”€è¾“å…¥æ¶ˆæ¯â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚                        â”‚
 â”‚                   â”‚â”€POST /chatâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚
 â”‚                   â”‚  Body: {"message":"ä½ å¥½"}â”‚
 â”‚                   â”‚                        â”‚
 â”‚                   â”‚â†HTTP 200 OKâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
 â”‚                   â”‚  Content-Type: text/event-stream
 â”‚                   â”‚                        â”‚
 â”‚                   â”‚â†event: startâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
 â”‚                   â”‚  data: {"message":"è¿æ¥æˆåŠŸ"}
 â”‚                   â”‚                        â”‚
 â”‚â”€æ˜¾ç¤º"å·²è¿æ¥"â”€â”€â”€â”€â†â”€â”‚                        â”‚
 â”‚                   â”‚                        â”‚
 â”‚                   â”‚â†event: thinkingâ”€â”€â”€â”€â”€â”€â”€â”¤
 â”‚                   â”‚  data: {"step":"æ­£åœ¨ç†è§£..."}
 â”‚                   â”‚                        â”‚
 â”‚â”€æ˜¾ç¤º"æ­£åœ¨æ€è€ƒ..."â†â”€â”‚                        â”‚
 â”‚                   â”‚                        â”‚
 â”‚                   â”‚â†event: thinkingâ”€â”€â”€â”€â”€â”€â”€â”¤
 â”‚                   â”‚  data: {"step":"åˆ†æä¸Šä¸‹æ–‡..."}
 â”‚                   â”‚                        â”‚
 â”‚â”€æ›´æ–°æ€è€ƒçŠ¶æ€â”€â”€â”€â”€â†â”€â”‚                        â”‚
 â”‚                   â”‚                        â”‚
 â”‚                   â”‚â†event: contentâ”€â”€â”€â”€â”€â”€â”€â”€â”¤
 â”‚                   â”‚  data: {"text":"ä½ "}
 â”‚                   â”‚                        â”‚
 â”‚â”€è¿½åŠ "ä½ "â”€â”€â”€â”€â”€â”€â”€â”€â†â”€â”‚                        â”‚
 â”‚                   â”‚                        â”‚
 â”‚                   â”‚â†event: contentâ”€â”€â”€â”€â”€â”€â”€â”€â”¤
 â”‚                   â”‚  data: {"text":"è¯´"}
 â”‚                   â”‚                        â”‚
 â”‚â”€è¿½åŠ "è¯´"â”€â”€â”€â”€â”€â”€â”€â”€â†â”€â”‚                        â”‚
 â”‚                   â”‚                        â”‚
 â”‚    ... (é€å­—è¿½åŠ )  â”‚                        â”‚
 â”‚                   â”‚                        â”‚
 â”‚                   â”‚â†event: doneâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
 â”‚                   â”‚  data: {"reason":"å®Œæˆ"}
 â”‚                   â”‚                        â”‚
 â”‚â”€å®Œæˆï¼Œç§»é™¤å…‰æ ‡â”€â”€â†â”€â”‚                        â”‚
 â”‚                   â”‚                        â”‚
```

### 2. å‰ç«¯æ ¸å¿ƒä»£ç è§£æ

**å‘é€æ¶ˆæ¯å‡½æ•°ï¼š**
```javascript
async function sendMessage() {
    const message = messageInput.value.trim();
    if (!message) return;

    // 1. æ˜¾ç¤ºç”¨æˆ·æ¶ˆæ¯
    addMessage(message, 'user');
    messageInput.value = '';
    sendButton.disabled = true;

    // 2. åˆ›å»ºAIæ¶ˆæ¯å®¹å™¨
    const aiMessageDiv = document.createElement('div');
    aiMessageDiv.className = 'message assistant';
    messagesContainer.appendChild(aiMessageDiv);

    // 3. æ€è€ƒçŠ¶æ€
    const thinkingDiv = document.createElement('div');
    thinkingDiv.className = 'thinking';
    thinkingDiv.textContent = 'å‡†å¤‡å›ç­”...';
    aiMessageDiv.appendChild(thinkingDiv);

    // 4. å†…å®¹åŒºåŸŸ
    const contentSpan = document.createElement('span');
    contentSpan.innerHTML = '';
    aiMessageDiv.appendChild(contentSpan);

    // 5. å…‰æ ‡
    const cursor = document.createElement('span');
    cursor.className = 'cursor';
    aiMessageDiv.appendChild(cursor);

    // 6. å‘é€è¯·æ±‚
    try {
        const response = await fetch('/chat', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ message: message })
        });

        // 7. è¯»å–æµ
        const reader = response.body.getReader();
        const decoder = new TextDecoder();

        while (true) {
            const { done, value } = await reader.read();
            if (done) break;

            const chunk = decoder.decode(value);
            const lines = chunk.split('\n');

            for (const line of lines) {
                if (line.startsWith('event: ')) {
                    const event = line.substring(7);
                    continue;
                }
                if (line.startsWith('data: ')) {
                    const data = JSON.parse(line.substring(6));

                    if (data.step) {
                        thinkingDiv.textContent = data.step;
                    } else if (data.text) {
                        thinkingDiv.style.display = 'none';
                        contentSpan.innerHTML += data.text;
                    }

                    messagesContainer.scrollTop = messagesContainer.scrollHeight;
                }
            }
        }

        cursor.remove();

    } catch (error) {
        contentSpan.innerHTML = 'æŠ±æ­‰ï¼Œå‡ºé”™äº†ï¼š' + error.message;
    }

    sendButton.disabled = false;
    messageInput.focus();
}
```

**å…³é”®ç‚¹ï¼š**

1. **Fetch APIï¼š**
   ```javascript
   fetch('/chat', {
       method: 'POST',
       headers: {'Content-Type': 'application/json'},
       body: JSON.stringify({ message: message })
   })
   ```

2. **ReadableStreamï¼š**
   ```javascript
   const reader = response.body.getReader();
   const { done, value } = await reader.read();
   ```

3. **TextDecoderï¼š**
   ```javascript
   const decoder = new TextDecoder();
   const chunk = decoder.decode(value);
   ```

4. **SSEè§£æï¼š**
   ```javascript
   if (line.startsWith('event: ')) {
       const event = line.substring(7);
   }
   if (line.startsWith('data: ')) {
       const data = JSON.parse(line.substring(6));
   }
   ```

---

## chat.htmlå‰ç«¯å®ç°

### 1. HTMLç»“æ„

```html
<div class="chat-container">
    <div class="chat-header">AIæµå¼èŠå¤©æ¼”ç¤º</div>

    <div class="messages" id="messages">
        <div class="message assistant">
            ä½ å¥½ï¼æˆ‘æ˜¯AIåŠ©æ‰‹ï¼Œä»Šå¤©æƒ³èŠä»€ä¹ˆå‘¢ï¼Ÿ
        </div>
    </div>

    <div class="input-area">
        <input type="text" id="messageInput" placeholder="è¾“å…¥æ¶ˆæ¯...">
        <button id="sendButton">å‘é€</button>
    </div>
</div>
```

### 2. CSSæ ·å¼

**å®¹å™¨ï¼š**
```css
.chat-container {
    width: 90%;
    max-width: 800px;
    height: 90vh;
    background: white;
    border-radius: 20px;
    display: flex;
    flex-direction: column;
}
```

**æ¶ˆæ¯æ°”æ³¡ï¼š**
```css
.message {
    max-width: 80%;
    padding: 15px 20px;
    border-radius: 18px;
}

.message.user {
    align-self: flex-end;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
}

.message.assistant {
    align-self: flex-start;
    background: white;
    color: #333;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}
```

**æ€è€ƒçŠ¶æ€ï¼š**
```css
.thinking {
    font-size: 0.85em;
    color: #666;
    font-style: italic;
    margin-bottom: 10px;
}

.thinking::before {
    content: "ğŸ’­ ";
}
```

**å…‰æ ‡åŠ¨ç”»ï¼š**
```css
.cursor {
    display: inline-block;
    width: 2px;
    height: 1.2em;
    background: #667eea;
    animation: blink 1s infinite;
}

@keyframes blink {
    0%, 50% { opacity: 1; }
    51%, 100% { opacity: 0; }
}
```

### 3. JavaScriptæ ¸å¿ƒåŠŸèƒ½

**æ·»åŠ æ¶ˆæ¯ï¼š**
```javascript
function addMessage(text, type) {
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${type}`;
    messageDiv.textContent = text;
    messagesContainer.appendChild(messageDiv);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
}
```

**è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨ï¼š**
```javascript
messagesContainer.scrollTop = messagesContainer.scrollHeight;
```

**ç¦ç”¨/å¯ç”¨å‘é€æŒ‰é’®ï¼š**
```javascript
sendButton.disabled = true;  // å‘é€æ—¶ç¦ç”¨
sendButton.disabled = false;  // å®Œæˆåå¯ç”¨
```

**äº‹ä»¶ç›‘å¬ï¼š**
```javascript
sendButton.addEventListener('click', sendMessage);

messageInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') sendMessage();
});
```

---

## è¿è¡Œå’Œæµ‹è¯•

### 1. å¯åŠ¨åç«¯æœåŠ¡

```bash
python examples/06_complete_chat.py
```

è¾“å‡ºï¼š
```
============================================================
å®Œæ•´AIèŠå¤©åº”ç”¨
============================================================

å¯åŠ¨æœåŠ¡...
APIç«¯ç‚¹:
  GET  http://localhost:8000/
  GET  http://localhost:8000/chat/{message}
  POST http://localhost:8000/chat

æŒ‰ Ctrl+C åœæ­¢æœåŠ¡
============================================================
```

### 2. æ‰“å¼€å‰ç«¯é¡µé¢

**æ–¹æ³•1ï¼šç›´æ¥æ‰“å¼€æ–‡ä»¶**
```bash
open examples/chat.html
```

**æ–¹æ³•2ï¼šä½¿ç”¨é™æ€æ–‡ä»¶æœåŠ¡å™¨**
```bash
python -m http.server 3000
# æµè§ˆå™¨è®¿é—®: http://localhost:3000/chat.html
```

### 3. æµ‹è¯•API

**æµ‹è¯•é¦–é¡µï¼ˆæµå¼è¾“å‡ºï¼‰ï¼š**
```bash
curl -N http://localhost:8000/
```

**æµ‹è¯•GETèŠå¤©æ¥å£ï¼š**
```bash
curl -N http://localhost:8000/chat/ä½ å¥½
```

**æµ‹è¯•POSTèŠå¤©æ¥å£ï¼š**
```bash
curl -N -X POST http://localhost:8000/chat \
  -H "Content-Type: application/json" \
  -d '{"message":"ä½ å¥½"}'
```

### 4. æŸ¥çœ‹SSEæµ

**åœ¨æµè§ˆå™¨å¼€å‘è€…å·¥å…·ä¸­ï¼š**
1. æŒ‰F12æ‰“å¼€å¼€å‘è€…å·¥å…·
2. åˆ‡æ¢åˆ°Networkæ ‡ç­¾
3. å‘é€ä¸€æ¡æ¶ˆæ¯
4. æ‰¾åˆ°`/chat`è¯·æ±‚
5. ç‚¹å‡»æŸ¥çœ‹è¯¦ç»†ä¿¡æ¯
6. åœ¨Responseæ ‡ç­¾æŸ¥çœ‹å®æ—¶æ•°æ®æµ

---

## æ‰©å±•å’Œä¼˜åŒ–

### 1. é›†æˆçœŸå®AIæ¨¡å‹

```python
from openai import OpenAI

client = OpenAI()

async def generate_with_ai(message: str):
    """ä½¿ç”¨çœŸå®AIç”Ÿæˆå“åº”"""

    # å‘é€æ€è€ƒäº‹ä»¶
    yield f"event: start\ndata: {json.dumps({'message': 'è¿æ¥æˆåŠŸ'})}\n\n"

    # è°ƒç”¨OpenAI API
    stream = client.chat.completions.create(
        model="gpt-3.5-turbo",
        messages=[{"role": "user", "content": message}],
        stream=True,
    )

    # æµå¼è¾“å‡º
    for chunk in stream:
        content = chunk.choices[0].delta.content
        if content:
            yield f"event: content\ndata: {json.dumps({'text': content})}\n\n"

    # å‘é€å®Œæˆäº‹ä»¶
    yield f"event: done\ndata: {json.dumps({'reason': 'å®Œæˆ'})}\n\n"

@app.post("/chat")
async def chat(message: dict):
    return StreamingResponse(
        generate_with_ai(message.get("message", "")),
        media_type="text/event-stream",
    )
```

### 2. æ·»åŠ å¯¹è¯å†å²

```python
from typing import List

# å­˜å‚¨å¯¹è¯å†å²ï¼ˆå®é™…åº”ç”¨åº”ä½¿ç”¨æ•°æ®åº“ï¼‰
conversation_history = {}

async def generate_with_history(message: str, session_id: str):
    """å¸¦å†å²è®°å½•çš„å¯¹è¯"""

    # è·å–å†å²è®°å½•
    history = conversation_history.get(session_id, [])

    # æ·»åŠ å½“å‰æ¶ˆæ¯
    history.append({"role": "user", "content": message})

    # è°ƒç”¨API
    stream = client.chat.completions.create(
        model="gpt-3.5-turbo",
        messages=history,
        stream=True,
    )

    # ç”Ÿæˆå“åº”
    response = ""
    for chunk in stream:
        content = chunk.choices[0].delta.content
        if content:
            response += content
            yield f"event: content\ndata: {json.dumps({'text': content})}\n\n"

    # ä¿å­˜AIå›å¤
    history.append({"role": "assistant", "content": response})
    conversation_history[session_id] = history

    yield f"event: done\ndata: {json.dumps({'reason': 'å®Œæˆ'})}\n\n"
```

### 3. æ·»åŠ Markdownæ”¯æŒ

**å‰ç«¯é›†æˆï¼š**
```html
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
```

```javascript
// æ¸²æŸ“Markdown
function appendContent(text) {
    const fullText = contentSpan.textContent + text;
    contentSpan.innerHTML = marked.parse(fullText);
}
```

### 4. æ·»åŠ ä»£ç é«˜äº®

```html
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
```

```javascript
// ä»£ç é«˜äº®
function appendContent(text) {
    contentSpan.innerHTML += text;
    // å®æ—¶é«˜äº®
    hljs.highlightAll();
}
```

### 5. æ€§èƒ½ä¼˜åŒ–

**åç«¯ä¼˜åŒ–ï¼š**
```python
from fastapi_cache import FastAPICache
from fastapi_cache.backends.redis import RedisBackend

# ç¼“å­˜ä¸­é—´ä»¶
@app.post("/chat")
@cache(expire=60)  # ç¼“å­˜60ç§’
async def chat(message: dict):
    # ...
```

**å‰ç«¯ä¼˜åŒ–ï¼š**
```javascript
// é˜²æŠ–
let debounceTimer;
messageInput.addEventListener('input', () => {
    clearTimeout(debounceTimer);
    debounceTimer = setTimeout(() => {
        // è¾“å…¥å»ºè®®
    }, 300);
});

// è™šæ‹Ÿæ»šåŠ¨ï¼ˆå¤§é‡æ¶ˆæ¯ï¼‰
import { VirtualList } from 'vue-virtual-scroll-list';
```

### 6. æ·»åŠ ç”¨æˆ·è®¤è¯

```python
from fastapi.security import HTTPBearer

security = HTTPBearer()

@app.post("/chat")
async def chat(
    message: dict,
    credentials: HTTPAuthorizationCredentials = Depends(security)
):
    # éªŒè¯token
    token = credentials.credentials
    if not validate_token(token):
        raise HTTPException(401, "Invalid token")

    # ...
```

---

## æ€»ç»“

### å®Œæ•´èŠå¤©åº”ç”¨æ ¸å¿ƒè¦ç‚¹

1. **FastAPIæ¡†æ¶**
   - ç°ä»£åŒ–Webæ¡†æ¶
   - å¼‚æ­¥æ”¯æŒ
   - è‡ªåŠ¨æ–‡æ¡£
   - ç±»å‹æç¤º

2. **StreamingResponse**
   - æµå¼æ•°æ®ä¼ è¾“
   - SSEåè®®æ”¯æŒ
   - å®æ—¶é€šä¿¡

3. **CORSé…ç½®**
   - è·¨åŸŸèµ„æºå…±äº«
   - å‰åç«¯åˆ†ç¦»
   - å®‰å…¨æ§åˆ¶

4. **å‰ç«¯å®ç°**
   - Fetch API
   - ReadableStream
   - TextDecoder
   - SSEè§£æ

5. **ç”¨æˆ·ä½“éªŒ**
   - æµå¼è¾“å‡º
   - æ€è€ƒå¯è§†åŒ–
   - å®æ—¶åé¦ˆ
   - å…‰æ ‡åŠ¨ç”»

### æŠ€æœ¯æ ˆæ€»ç»“

| å±‚æ¬¡ | æŠ€æœ¯ | è¯´æ˜ |
|------|------|------|
| **åç«¯æ¡†æ¶** | FastAPI | ç°ä»£Webæ¡†æ¶ |
| **æœåŠ¡å™¨** | uvicorn | ASGIæœåŠ¡å™¨ |
| **åè®®** | SSE | Server-Sent Events |
| **å‰ç«¯** | åŸç”ŸJS | æ— æ¡†æ¶ä¾èµ– |
| **æ ·å¼** | CSS3 | ç°ä»£UI |
| **é€šä¿¡** | Fetch API | HTTPè¯·æ±‚ |

### æœ€ä½³å®è·µ

âœ… **æ¨èåšæ³•ï¼š**
- ä½¿ç”¨å¼‚æ­¥ç”Ÿæˆå™¨
- æ­£ç¡®é…ç½®CORS
- æ·»åŠ é”™è¯¯å¤„ç†
- å®ç°åŠ è½½çŠ¶æ€
- ä¼˜åŒ–ç”¨æˆ·ä½“éªŒ

âŒ **é¿å…åšæ³•ï¼š**
- ä¸è¦å¿˜è®°å¤„ç†æµç»“æŸ
- ä¸è¦å¿½ç•¥CORSé—®é¢˜
- ä¸è¦åœ¨ä¸»çº¿ç¨‹ä¸­é˜»å¡
- ä¸è¦å¿½ç•¥é”™è¯¯å¤„ç†
- ä¸è¦å¿˜è®°é‡Šæ”¾èµ„æº

---

## æ‰©å±•é˜…è¯»

- [FastAPIå®˜æ–¹æ–‡æ¡£](https://fastapi.tiangolo.com/)
- [MDN - Fetch API](https://developer.mozilla.org/zh-CN/docs/Web/API/Fetch_API)
- [MDN - ReadableStream](https://developer.mozilla.org/zh-CN/docs/Web/API/ReadableStream)

---

æ„å»ºå®Œæ•´èŠå¤©åº”ç”¨ï¼Œä½ å°±èƒ½åƒChatGPTä¸€æ ·å®ç°æµç•…çš„AIå¯¹è¯ä½“éªŒï¼
